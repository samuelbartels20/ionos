---
# Envoy Configuration
apiVersion: v1
kind: ConfigMap
metadata:
  name: authelia-envoy-config
  namespace: security
  labels:
    app.kubernetes.io/name: authelia-api-gateway
    app.kubernetes.io/component: api-management
data:
  envoy.yaml: |
    admin:
      address:
        socket_address:
          address: 0.0.0.0
          port_value: 9901

    static_resources:
      listeners:
        - name: listener_http
          address:
            socket_address:
              address: 0.0.0.0
              port_value: 8080
          filter_chains:
            - filters:
                - name: envoy.filters.network.http_connection_manager
                  typed_config:
                    "@type": type.googleapis.com/envoy.extensions.filters.network.http_connection_manager.v3.HttpConnectionManager
                    stat_prefix: ingress_http
                    access_log:
                      - name: envoy.access_loggers.stdout
                        typed_config:
                          "@type": type.googleapis.com/envoy.extensions.access_loggers.stream.v3.StdoutAccessLog
                    http_filters:
                      # Rate limiting
                      - name: envoy.filters.http.local_ratelimit
                        typed_config:
                          "@type": type.googleapis.com/udpa.type.v1.TypedStruct
                          type_url: type.googleapis.com/envoy.extensions.filters.http.local_ratelimit.v3.LocalRateLimit
                          value:
                            stat_prefix: http_local_rate_limiter
                            token_bucket:
                              max_tokens: 1000
                              tokens_per_fill: 1000
                              fill_interval: 60s
                            filter_enabled:
                              runtime_key: local_rate_limit_enabled
                              default_value:
                                numerator: 100
                                denominator: HUNDRED
                            filter_enforced:
                              runtime_key: local_rate_limit_enforced
                              default_value:
                                numerator: 100
                                denominator: HUNDRED

                      # JWT Authentication
                      - name: envoy.filters.http.jwt_authn
                        typed_config:
                          "@type": type.googleapis.com/envoy.extensions.filters.http.jwt_authn.v3.JwtAuthentication
                          providers:
                            authelia:
                              issuer: "https://auth.samcloud.online"
                              audiences:
                                - "authelia"
                              remote_jwks:
                                http_uri:
                                  uri: "https://auth.samcloud.online/api/oidc/jwks"
                                  cluster: authelia_cluster
                                  timeout: 5s
                                cache_duration: 300s
                          rules:
                            - match:
                                prefix: "/api/"
                              requires:
                                provider_name: "authelia"

                      # External authorization (Authelia)
                      - name: envoy.filters.http.ext_authz
                        typed_config:
                          "@type": type.googleapis.com/envoy.extensions.filters.http.ext_authz.v3.ExtAuthz
                          http_service:
                            server_uri:
                              uri: "http://authelia.security.svc.cluster.local:9091/api/verify"
                              cluster: authelia_cluster
                              timeout: 5s
                            authorization_request:
                              allowed_headers:
                                patterns:
                                  - exact: "authorization"
                                  - exact: "x-forwarded-proto"
                                  - exact: "x-forwarded-host"
                                  - exact: "x-forwarded-uri"
                            authorization_response:
                              allowed_upstream_headers:
                                patterns:
                                  - exact: "remote-user"
                                  - exact: "remote-name"
                                  - exact: "remote-email"
                                  - exact: "remote-groups"

                      # Router (must be last)
                      - name: envoy.filters.http.router
                        typed_config:
                          "@type": type.googleapis.com/envoy.extensions.filters.http.router.v3.Router

                    route_config:
                      name: local_route
                      virtual_hosts:
                        - name: api_service
                          domains:
                            - "*"
                          routes:
                            # API routes
                            - match:
                                prefix: "/api/v1/auth"
                              route:
                                cluster: authelia_cluster
                                timeout: 30s
                            - match:
                                prefix: "/api/v1/users"
                              route:
                                cluster: authelia_cluster
                                timeout: 30s
                            - match:
                                prefix: "/api/v1/admin"
                              route:
                                cluster: authelia_cluster
                                timeout: 30s
                            # Health check
                            - match:
                                prefix: "/health"
                              direct_response:
                                status: 200
                                body:
                                  inline_string: "OK"
                            # Metrics
                            - match:
                                prefix: "/metrics"
                              route:
                                cluster: prometheus_cluster

      clusters:
        - name: authelia_cluster
          connect_timeout: 5s
          type: STRICT_DNS
          lb_policy: ROUND_ROBIN
          load_assignment:
            cluster_name: authelia_cluster
            endpoints:
              - lb_endpoints:
                  - endpoint:
                      address:
                        socket_address:
                          address: authelia.security.svc.cluster.local
                          port_value: 80
          health_checks:
            - timeout: 3s
              interval: 30s
              unhealthy_threshold: 3
              healthy_threshold: 2
              http_health_check:
                path: "/api/health"

        - name: prometheus_cluster
          connect_timeout: 5s
          type: STRICT_DNS
          lb_policy: ROUND_ROBIN
          load_assignment:
            cluster_name: prometheus_cluster
            endpoints:
              - lb_endpoints:
                  - endpoint:
                      address:
                        socket_address:
                          address: prometheus.observability.svc.cluster.local
                          port_value: 9090 